<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>PDF抽出 & PDF挿入ツール（動作版）</title>
<!-- 修正: バージョンを指定し、unpkgを使用することで安定性を向上 -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 30px; }
  input, button { margin: 5px 0; padding: 5px; }
  h2, h3 { color: #333; }
  hr { margin: 30px 0; }
</style>
</head>
<body>
<h2>PDFツール（動作版）</h2>

<h3>① PDF 1ページ抽出</h3>
<input type="file" id="extractPdf"><br />
ページ番号: <input type="number" id="extractPage" min="1"><br />
<button id="extractBtn">抽出してダウンロード</button>

<hr />

<h3>② PDFページ挿入</h3>
<input type="file" id="basePdf"><br />
<input type="file" id="insertPdf"><br />
PDF A に挿入する位置: <input type="number" id="insertPos" min="1"><br />
PDF B の抽出ページ番号: <input type="number" id="insertPage" min="1"><br />
<button id="insertBtn">挿入してダウンロード</button>

<script>
// 修正: ライブラリが読み込まれているか確認
if (typeof PDFLib === 'undefined') {
  alert('PDF-Lib ライブラリの読み込みに失敗しました。インターネット接続を確認するか、ページを再読み込みしてください。');
}

// PDFLibが未定義の場合にエラーにならないよう空オブジェクトをフォールバックに設定
const { PDFDocument } = (typeof PDFLib !== 'undefined' ? PDFLib : {});

let extractFileData = null;
let baseFileData = null;
let insertFileData = null;

// ファイルアップロード時にArrayBufferに変換
document.getElementById("extractPdf").addEventListener("change", async (e) => {
  if (e.target.files.length === 0) return; // ファイル選択キャンセルの対策
  extractFileData = await e.target.files[0].arrayBuffer();
});
document.getElementById("basePdf").addEventListener("change", async (e) => {
  if (e.target.files.length === 0) return;
  baseFileData = await e.target.files[0].arrayBuffer();
});
document.getElementById("insertPdf").addEventListener("change", async (e) => {
  if (e.target.files.length === 0) return;
  insertFileData = await e.target.files[0].arrayBuffer();
});

// ① PDF 1ページ抽出
document.getElementById("extractBtn").addEventListener("click", async () => {
  // ライブラリチェック
  if (!PDFDocument) {
    alert('PDFライブラリが正しく読み込まれていません。');
    return;
  }

  const pageNum = parseInt(document.getElementById("extractPage").value, 10);
  if (!extractFileData || !pageNum) {
    alert("ファイルとページ番号を入力してください");
    return;
  }

  try {
    const pdf = await PDFDocument.load(extractFileData);
    if (pageNum < 1 || pageNum > pdf.getPageCount()) {
      alert("ページ番号が範囲外です");
      return;
    }

    const newPdf = await PDFDocument.create();
    const [copiedPage] = await newPdf.copyPages(pdf, [pageNum - 1]);
    newPdf.addPage(copiedPage);

    const pdfBytes = await newPdf.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "extracted_page.pdf";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

  } catch (e) {
    alert("エラーが発生しました: " + e.message);
    console.error(e);
  }
});

// ② PDFページ挿入
document.getElementById("insertBtn").addEventListener("click", async () => {
  if (!PDFDocument) {
    alert('PDFライブラリが正しく読み込まれていません。');
    return;
  }

  const insertPos = parseInt(document.getElementById("insertPos").value, 10);
  const insertPage = parseInt(document.getElementById("insertPage").value, 10);

  if (!baseFileData || !insertFileData || !insertPos || !insertPage) {
    alert("すべてのファイルとページ番号を入力してください");
    return;
  }

  try {
    const basePdf = await PDFDocument.load(baseFileData);
    const insertPdf = await PDFDocument.load(insertFileData);
    const newPdf = await PDFDocument.create();

    if (insertPage < 1 || insertPage > insertPdf.getPageCount()) {
      alert("差し込みページ番号が範囲外です");
      return;
    }

    const basePages = await newPdf.copyPages(basePdf, basePdf.getPageIndices());
    const [copiedPage] = await newPdf.copyPages(insertPdf, [insertPage - 1]);

    for (let i = 0; i < basePages.length; i++) {
      newPdf.addPage(basePages[i]);
      if (i === insertPos - 1) {
        newPdf.addPage(copiedPage);
      }
    }

    const pdfBytes = await newPdf.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "merged.pdf";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

  } catch (e) {
    alert("エラーが発生しました: " + e.message);
    console.error(e);
  }
});
</script>
</body>
</html>
