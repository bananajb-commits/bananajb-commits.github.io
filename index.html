<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDF編集ツール | 高速・軽量・高画質</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #4f46e5; --bg: #f1f5f9; --border: #cbd5e1; --accent: #10b981; --warning: #f59e0b; }
        body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        #mode-selection {
            position: fixed; inset: 0; background: #1e293b; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .mode-cards { display: flex; gap: 20px; margin-top: 30px; }
        .mode-card {
            background: white; color: #1e293b; padding: 30px; border-radius: 12px; width: 240px;
            text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }
        .mode-card:hover { transform: translateY(-5px); background: var(--primary); color: white; }

        header { background: #1e293b; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        main { display: flex; flex: 1; overflow: hidden; }

        #merge-view { flex: 1; display: flex; gap: 2px; background: #cbd5e1; width: 100%; }
        .column { flex: 1; background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }
        .column-header { padding: 12px; background: white; border-bottom: 1px solid var(--border); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; }

        .guide-box { 
            padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px;
            background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; text-align: center;
        }
        .guide-box.active { background: var(--primary); color: white; border-color: var(--primary); }
        .guide-box.step2.ready { background: var(--accent); color: white; border-color: var(--accent); animation: pulse-light 2s infinite; }

        .page-card { 
            background: white; border: 3px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            width: 90%; max-width: 500px; position: relative; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .page-card img { 
            width: 100%; height: auto; display: block; 
            image-rendering: -webkit-optimize-contrast; /* 文字をくっきり見せる */
        }
        .page-card:hover { border-color: var(--primary); }
        .page-card.selected { border-color: var(--primary) !important; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }

        .page-footer { padding: 6px 10px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-size: 12px; }

        .insert-divider { width: 100%; display: flex; justify-content: center; padding: 6px 0; }
        .btn-insert-here {
            background: #e2e8f0; border: 1px dashed #94a3b8; color: #64748b;
            padding: 6px 25px; border-radius: 20px; font-weight: bold; cursor: pointer;
            transition: 0.2s; opacity: 0.5; pointer-events: none; font-size: 0.8rem;
        }
        .btn-insert-here.active { 
            opacity: 1; pointer-events: auto; background: var(--accent); color: white; border: 1px solid white;
        }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-extract { background: var(--warning); color: white; }
        .btn-del { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; border: 2px solid white; cursor: pointer; z-index: 10; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .file-label { display: block; padding: 8px; border: 2px dashed var(--primary); border-radius: 8px; text-align: center; cursor: pointer; color: var(--primary); font-weight: bold; font-size: 0.9rem; }
        
        #status { position: fixed; inset: 0; background: rgba(0,0,0,0.8); color: white; display: none; z-index: 10000; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="mode-selection">
    <h1>PDF 編集ツール</h1>
    <p style="opacity: 0.8; margin-bottom: 20px;">高速・軽量・高画質版</p>
    <div class="mode-cards">
        <div class="mode-card" onclick="switchMode('extract')"><h2>1枚抽出</h2><p>特定のページを保存</p></div>
        <div class="mode-card" onclick="switchMode('merge')"><h2>ページ挿入・結合</h2><p>ページを選んで差し込み</p></div>
    </div>
</div>

<header>
    <button class="btn" style="background:#475569; color:white;" onclick="location.reload()">← 戻る</button>
    <span id="current-mode-title" style="font-weight: bold;"></span>
    <div id="merge-actions" class="hidden">
        <button id="saveMergedBtn" class="btn" style="background:var(--accent); color:white;">完成したPDFを保存</button>
    </div>
</header>

<main>
    <div id="extraction-view" class="column hidden">
        <div class="column-header">
            <label class="file-label">PDFを選択<input type="file" id="extractInput" accept=".pdf" style="display:none;"></label>
        </div>
        <div id="extract-list" class="scroll-area"></div>
    </div>

    <div id="merge-view" class="hidden">
        <div class="column">
            <div class="column-header">
                <div id="guide-step1" class="guide-box active">① 挿入したいページを選択</div>
                <label class="file-label">素材PDFを選択<input type="file" id="sourceInput" accept=".pdf" style="display:none;"></label>
            </div>
            <div id="source-list" class="scroll-area"></div>
        </div>
        <div class="column">
            <div class="column-header">
                <div id="guide-step2" class="guide-box step2">② 「＋」を押して挿入</div>
                <label class="file-label">ベースPDFを選択<input type="file" id="targetInput" accept=".pdf" style="display:none;"></label>
            </div>
            <div id="target-list" class="scroll-area"></div>
        </div>
    </div>
</main>

<div id="status"><div class="spinner"></div><div id="status-text">処理中...</div></div>

<script>
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    const pdfDataMap = new Map();
    let fileIdCounter = 0;
    let selectedSourcePage = null;

    function switchMode(mode) {
        document.getElementById('mode-selection').classList.add('hidden');
        const isExtract = mode === 'extract';
        document.getElementById(isExtract ? 'extraction-view' : 'merge-view').classList.remove('hidden');
        if (!isExtract) document.getElementById('merge-actions').classList.remove('hidden');
        document.getElementById('current-mode-title').innerText = isExtract ? '1枚抽出モード' : 'ページ挿入・結合モード';
    }

    const setupInput = (inputId, containerId, isExtract, isTarget) => {
        document.getElementById(inputId).addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showStatus('PDFを読み込み中...');
            
            try {
                const buffer = await file.arrayBuffer();
                const fileId = 'f' + (fileIdCounter++);
                pdfDataMap.set(fileId, buffer);
                
                const pdf = await pdfjsLib.getDocument({data: buffer.slice(0)}).promise;
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if (isTarget) container.appendChild(createInsertDivider());

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    // 1.3倍スケール + CSS鮮明化が最もコスパが良い
                    const viewport = page.getViewport({scale: 1.3});
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                    
                    // Blob方式に変換（Base64より圧倒的にメモリに優しい）
                    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
                    const imgUrl = URL.createObjectURL(blob);
                    
                    container.appendChild(createCard(fileId, i, imgUrl, isExtract, isTarget));
                    if (isTarget) container.appendChild(createInsertDivider());
                    if (i % 10 === 0) updateStatusText(`${i}/${pdf.numPages} ページ完了`);
                }
            } catch (err) { alert('読み込みエラー: ' + err.message); }
            hideStatus();
        });
    };

    setupInput('extractInput', 'extract-list', true, false);
    setupInput('sourceInput', 'source-list', false, false);
    setupInput('targetInput', 'target-list', false, true);

    function createCard(fid, pnum, imgUrl, isExt, isTar) {
        const card = document.createElement('div');
        card.className = 'page-card';
        card.setAttribute('data-fid', fid);
        card.setAttribute('data-pnum', pnum);
        card.innerHTML = `<img src="${imgUrl}"><div class="page-footer"><span>P.${pnum}</span></div>`;
        
        if (isExt) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-extract'; btn.innerText = '保存';
            btn.onclick = (e) => { e.stopPropagation(); extractSinglePage(fid, pnum); };
            card.querySelector('.page-footer').appendChild(btn);
        } else if (!isTar) {
            card.onclick = () => {
                document.querySelectorAll('#source-list .page-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedSourcePage = { fid, pnum, imgUrl };
                document.querySelectorAll('.btn-insert-here').forEach(b => b.classList.add('active'));
                document.getElementById('guide-step2').classList.add('ready');
            };
        } else {
            const del = document.createElement('button');
            del.className = 'btn-del'; del.innerHTML = '×';
            del.onclick = (e) => { 
                e.stopPropagation(); 
                URL.revokeObjectURL(imgUrl); // メモリ解放
                card.nextSibling.remove(); 
                card.remove(); 
            };
            card.appendChild(del);
        }
        return card;
    }

    function createInsertDivider() {
        const div = document.createElement('div');
        div.className = 'insert-divider';
        const btn = document.createElement('button');
        btn.className = 'btn-insert-here';
        if (selectedSourcePage) btn.classList.add('active');
        btn.innerHTML = '＋ 挿入';
        btn.onclick = () => {
            if (!selectedSourcePage) return;
            const newCard = createCard(selectedSourcePage.fid, selectedSourcePage.pnum, selectedSourcePage.imgUrl, false, true);
            div.after(newCard, createInsertDivider());
        };
        div.appendChild(btn);
        return div;
    }

    async function extractSinglePage(fid, pnum) {
        showStatus('生成中...');
        try {
            const srcPdf = await PDFDocument.load(pdfDataMap.get(fid).slice(0), { ignoreEncryption: true });
            const outPdf = await PDFDocument.create();
            const [page] = await outPdf.copyPages(srcPdf, [pnum - 1]);
            outPdf.addPage(page);
            download(await outPdf.save(), `extract_p${pnum}.pdf`);
        } catch (e) { alert('失敗: ' + e.message); }
        hideStatus();
    }

    async function finalizeMerge() {
        const cards = document.querySelectorAll('#target-list .page-card');
        if (!cards.length) return alert('ページがありません');
        showStatus('結合中...');
        try {
            const outPdf = await PDFDocument.create();
            const cache = new Map();
            for (const card of cards) {
                const fid = card.getAttribute('data-fid');
                const pnum = parseInt(card.getAttribute('data-pnum'));
                if (!cache.has(fid)) {
                    cache.set(fid, await PDFDocument.load(pdfDataMap.get(fid).slice(0), { ignoreEncryption: true }));
                }
                const [copied] = await outPdf.copyPages(cache.get(fid), [pnum - 1]);
                outPdf.addPage(copied);
            }
            download(await outPdf.save(), 'merged.pdf');
        } catch (e) { alert('結合失敗: ' + e.message); }
        hideStatus();
    }

    document.getElementById('saveMergedBtn').onclick = finalizeMerge;
    function showStatus(t) { document.getElementById('status-text').innerText = t; document.getElementById('status').style.display = 'flex'; }
    function updateStatusText(t) { document.getElementById('status-text').innerText = t; }
    function hideStatus() { document.getElementById('status').style.display = 'none'; }
    function download(bytes, name) {
        const blob = new Blob([bytes], {type: 'application/pdf'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
</script>
</body>
</html>
