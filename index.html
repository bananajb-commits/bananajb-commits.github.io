<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>プロ仕様 PDF編集ツール</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #4f46e5; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: #1e293b; color: white; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        main { display: grid; grid-template-columns: 1fr 1fr; flex: 1; overflow: hidden; gap: 2px; background: #cbd5e1; }

        /* 左右共通カラム設定 */
        .column { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }
        .column-header { padding: 15px; background: white; border-bottom: 1px solid var(--border); z-index: 10; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 25px; }

        /* ファイル入力装飾 */
        .file-label { display: block; padding: 10px; border: 2px dashed var(--primary); border-radius: 8px; text-align: center; cursor: pointer; color: var(--primary); font-weight: bold; transition: 0.2s; }
        .file-label:hover { background: var(--primary); color: white; }

        /* 巨大なページカード */
        .page-card { 
            background: white; 
            border: 1px solid var(--border); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 600px; 
            position: relative; 
            cursor: grab;
            transition: transform 0.2s;
        }
        .page-card:active { cursor: grabbing; }
        .page-card img { width: 100%; height: auto; display: block; }
        
        /* ページ情報とアクション */
        .page-footer { padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-top: 1px solid #eee; }
        .page-num { font-size: 12px; font-weight: bold; color: #64748b; }

        /* ボタン類 */
        .btn-extract { background: #f59e0b; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: bold; }
        .btn-extract:hover { opacity: 0.8; }
        .btn-del { position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .btn-save-all { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* ステータスバー */
        #status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; display: none; z-index: 1000; }

        .empty-hint { margin-top: 100px; color: #94a3b8; text-align: center; }
        .badge { background: #e2e8f0; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px; }
    </style>
</head>
<body>

<header>
    <div style="font-size: 1.2rem; font-weight: bold;">PDF Visual Editor</div>
    <div id="global-actions">
        <button id="saveTargetBtn" class="btn-save-all">右側のPDFを保存（結合完了）</button>
    </div>
</header>

<main>
    <!-- 左側：素材PDF（挿入したいページを選ぶ） -->
    <div class="column">
        <div class="column-header">
            <div style="margin-bottom: 10px; font-weight: bold;"><span class="badge">素材</span> 挿入したいPDFを選択</div>
            <label class="file-label">
                ファイルを選択
                <input type="file" id="sourceInput" accept=".pdf" style="display: none;">
            </label>
        </div>
        <div id="source-list" class="scroll-area">
            <div class="empty-hint">ここに挿入したいPDFが表示されます</div>
        </div>
    </div>

    <!-- 右側：ベースPDF（受け入れ先） -->
    <div class="column">
        <div class="column-header">
            <div style="margin-bottom: 10px; font-weight: bold;"><span class="badge">ベース</span> 挿入先のPDFを選択</div>
            <label class="file-label">
                ファイルを選択
                <input type="file" id="targetInput" accept=".pdf" style="display: none;">
            </label>
        </div>
        <div id="target-list" class="scroll-area">
            <div class="empty-hint">ここにベースとなるPDFが表示されます</div>
        </div>
    </div>
</main>

<div id="status"></div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const pdfDataMap = new Map(); // fileId -> ArrayBuffer
    let fileIdCounter = 0;

    // --- ドラッグ＆ドロップ設定 ---
    // 左側（素材）
    new Sortable(document.getElementById('source-list'), {
        group: { name: 'pdf-pages', pull: 'clone', put: false },
        sort: false,
        animation: 150
    });

    // 右側（ベース）
    new Sortable(document.getElementById('target-list'), {
        group: 'pdf-pages',
        animation: 150,
        onAdd: function (evt) {
            const item = evt.item;
            // 削除ボタンを追加
            if (!item.querySelector('.btn-del')) {
                const btn = document.createElement('button');
                btn.className = 'btn-del';
                btn.innerHTML = '×';
                btn.onclick = () => item.remove();
                item.appendChild(btn);
            }
            updateHints();
        }
    });

    // --- ファイル読み込み処理 ---
    document.getElementById('sourceInput').addEventListener('change', (e) => handleFileSelect(e, 'source-list'));
    document.getElementById('targetInput').addEventListener('change', (e) => handleFileSelect(e, 'target-list'));

    async function handleFileSelect(e, containerId) {
        const file = e.target.files[0];
        if (!file) return;

        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        const fileId = 'f' + (fileIdCounter++);
        const arrayBuffer = await file.arrayBuffer();
        pdfDataMap.set(fileId, arrayBuffer);

        showStatus(`${file.name} を読み込み中...`);
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({scale: 0.8}); // 大きめに表示
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({canvasContext: canvas.getContext('2d'), viewport: viewport}).promise;

            const card = document.createElement('div');
            card.className = 'page-card';
            card.dataset.fileId = fileId;
            card.dataset.pageNum = i;
            
            // カードの中身
            card.innerHTML = `
                <img src="${canvas.toDataURL('image/jpeg', 0.8)}">
                <div class="page-footer">
                    <span class="page-num">P.${i} (${file.name.substring(0,10)}...)</span>
                    <button class="btn-extract" onclick="extractSinglePage('${fileId}', ${i})">この1枚を保存</button>
                </div>
            `;

            // 右側（ベース）の場合は削除ボタンを最初からつける
            if (containerId === 'target-list') {
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-del';
                delBtn.innerHTML = '×';
                delBtn.onclick = () => { card.remove(); updateHints(); };
                card.appendChild(delBtn);
            }

            container.appendChild(card);
            
            // 描画中にUIを固めないための休憩
            if (i % 2 === 0) {
                showStatus(`${file.name}: ${i}/${pdf.numPages} ページ描画中...`);
                await new Promise(r => setTimeout(r, 10));
            }
        }
        hideStatus();
        updateHints();
    }

    // --- 1枚だけ抽出モード ---
    async function extractSinglePage(fileId, pageNum) {
        showStatus('ページを抽出中...');
        try {
            const srcBytes = pdfDataMap.get(fileId);
            const srcPdf = await PDFLib.PDFDocument.load(srcBytes);
            const outPdf = await PDFLib.PDFDocument.create();
            const [page] = await outPdf.copyPages(srcPdf, [pageNum - 1]);
            outPdf.addPage(page);
            
            const bytes = await outPdf.save();
            downloadBlob(bytes, `page_${pageNum}.pdf`);
        } catch (e) {
            alert('抽出エラーが発生しました');
        }
        hideStatus();
    }

    // --- 右側のPDFを保存（結合） ---
    document.getElementById('saveTargetBtn').addEventListener('click', async () => {
        const items = document.querySelectorAll('#target-list .page-card');
        if (!items.length) return alert('右側にページがありません');

        showStatus('PDFを結合して生成中...');
        try {
            const outPdf = await PDFLib.PDFDocument.create();
            for (const item of items) {
                const fId = item.dataset.fileId;
                const pNum = parseInt(item.dataset.pageNum);
                const srcPdf = await PDFLib.PDFDocument.load(pdfDataMap.get(fId));
                const [page] = await outPdf.copyPages(srcPdf, [pNum - 1]);
                outPdf.addPage(page);
            }
            const bytes = await outPdf.save();
            downloadBlob(bytes, 'merged_document.pdf');
        } catch (e) {
            alert('結合エラーが発生しました');
        }
        hideStatus();
    });

    // --- ヘルパー関数 ---
    function showStatus(text) {
        const s = document.getElementById('status');
        s.innerText = text;
        s.style.display = 'block';
    }
    function hideStatus() { document.getElementById('status').style.display = 'none'; }

    function downloadBlob(bytes, name) {
        const blob = new Blob([bytes], {type: 'application/pdf'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
    }

    function updateHints() {
        const sHint = document.querySelector('#source-list .empty-hint');
        if (sHint) sHint.style.display = document.querySelectorAll('#source-list .page-card').length ? 'none' : 'block';
        
        const tHint = document.querySelector('#target-list .empty-hint');
        if (tHint) tHint.style.display = document.querySelectorAll('#target-list .page-card').length ? 'none' : 'block';
    }
</script>
</body>
</html>
